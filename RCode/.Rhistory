i.ee<-( tao[i]*eta[i]*gam[i] + tao[i]*eta[i]*del[i] )/2
i.dd<- ( tao[i]*eta[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i.eg<- ( tao[i]*eta[i]*gam[i] )/2
i.ed<- ( tao[i]*eta[i]*del[i] )/2
i.gd<- ( tao[i]*gam[i]*del[i] )/2
I<-matrix(c(i.tt,i.ee,i.gg,i.dd,
i.ee,i.ee,i.eg,i.ed,
i.gg,i.eg,i.gg,i.gd,
i.dd,i.ed,i.gd,i.dd),nrow=4, ncol=4, byrow = TRUE)
I.cf<-I.cf+I
cov1<-mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
cov2<-mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
invI.closeform <- invI.closeform + solve(I)
v.tt = i.tt + cov1+cov2#cov(y11,y12)+cov(y21,y22)
v.ee = i.ee
v.gg = i.gg
v.dd = i.dd + cov2#cov(y21,y22)
v.te = i.ee + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.tg = i.gg + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.td = i.dd + cov1#cov(y21,y22)
v.eg = i.eg + cov2/2#cov(y21,y22)/2
v.ed = i.ed + cov2/2#cov(y21,y22)/2
v.gd = i.gd + cov2/2#cov(y21,y22)/2
V.cf<-V.cf+matrix( c(v.tt, v.te, v.tg, v.td,
v.te, v.ee, v.eg, v.ed,
v.tg, v.eg, v.gg, v.gd,
v.td, v.ed, v.gd, v.td),nrow=4, ncol=4, byrow = TRUE)
i.ep = matrix(c(i.ee, i.eg, i.ed), ncol = 3)
i.pp = matrix(c(i.tt, i.gg, i.dd, i.gg, i.gg, i.gd,
i.dd, i.gd, i.dd), nrow = 3, ncol = 3)
A = i.ee - i.ep %*% solve(i.pp) %*% t(i.ep)
v.pe = matrix(c(v.te, v.eg, v.ed), nrow = 3)
v.pp = matrix(c(v.tt, v.tg, v.td, v.tg, v.gg, v.gd, v.td,
v.gd, v.td), nrow = 3, ncol = 3)
B = v.ee - 2 * i.ep %*% solve(i.pp) %*% v.pe +
i.ep %*% solve(i.pp) %*% v.pp %*% solve(i.pp) %*% t(i.ep)
#wald test
wna = log(eta[i]) * A * log(eta[i]) * 2*seq
wrb = log(eta[i]) * A^2 / B * log(eta[i]) * 2*seq
if( wna<=qchisq(0.95, 1) )  W.na1 = W.na1+1
if( wrb<=qchisq(0.95, 1) )  W.rb1 = W.rb1+1
#log LR test :par=exp(.)
lik<-function(par){
ll=sum(log(par[1])*y11-par[1]+log(par[1]*par[2]*par[3])*y12-par[1]*par[2]*par[3])+
sum(log(par[1]*par[2]*par[4])*y21-par[1]*par[2]*par[4]+ log(par[1]*par[3]*par[4])*y22-par[1]*par[3]*par[4])
# ll= par[1]*sum(y11)-seq*exp(param[1])
#   +sum(par[1:3])*sum(y12)-seq*exp(sum(par[1:3]))
#   +(par[1]+par[2]+par[4])*sum(y21)-seq*exp(par[1]+par[2]+param[4])
#   +(par[1]+par[3]+par[4])*sum(y22)-seq*exp(param[1]+param[3]+param[4])
return(ll)
}
#null MLE
Y<-c(y11,y12,y21,y22)
df.cor = data.frame(Y,X,Z,G)
mod.0 <- glm(Y ~ Z + G, family = poisson(link = "log"), df.cor)
tao.0[i]<-exp(mod.0$coefficients[1])
gam.0[i]<-exp(mod.0$coefficients[2])
del.0[i]<-exp(mod.0$coefficients[3])
#null cov
cov1<-mean( (y11-tao.0[i])*(y12-tao.0[i]*gam.0[i]) )
cov2<-mean( (y21-tao.0[i]*del.0[i])*(y22-tao.0[i]*gam.0[i]*del.0[i]) )
#LR Test
l1 = lik(c(tao[i], eta[i], gam[i], del[i]) )
l0 = lik(c(tao.0[i], 1, gam.0[i], del.0[i]))
if( (2*(l1-l0))<=qchisq(0.95, 1) )  LR.na1 = LR.na1+1
if( (2*A/B*(l1-l0))<=qchisq(0.95, 1) )  LR.rb1 = LR.rb1+1
#score test
i0.tt<-( tao.0[i]+tao.0[i]*gam.0[i] + tao.0[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i0.gg<-( tao.0[i]*gam.0[i] + tao.0[i]*gam.0[i]*del.0[i] )/2
i0.ee<-( tao.0[i]*gam.0[i] + tao.0[i]*del.0[i] )/2
i0.dd<- ( tao.0[i]*del.0[i]+tao.0[i]*gam.0[i]*del.0[i] )/2
i0.eg<- ( tao.0[i]*gam.0[i] )/2
i0.ed<- ( tao.0[i]*del.0[i] )/2
i0.gd<- ( tao.0[i]*gam.0[i]*del.0[i] )/2
I0<-matrix(c(i0.tt,i0.ee,i0.gg,i0.dd,
i0.ee,i0.ee,i0.eg,i0.ed,
i0.gg,i0.eg,i0.gg,i0.gd,
i0.dd,i0.ed,i0.gd,i0.dd),nrow=4, ncol=4, byrow = TRUE)
I0.cf<-I0.cf+I0
invI0.closeform <- invI0.closeform + solve(I0)
v0.tt = i0.tt + cov1+cov2
v0.ee = i0.ee
v0.gg = i0.gg
v0.dd.0 = i0.dd + cov2
v0.te = i0.ee + cov1/2+cov2/2
v0.tg = i0.gg + cov1/2+cov2/2
v0.td = i0.dd + cov2
v0.eg = i0.eg + cov2/2
v0.ed = i0.ed + cov2/2
v0.gd = i0.gd + cov2/2
V0.cf<-V.cf+matrix( c(v0.tt, v0.te, v0.tg, v0.td,
v0.te, v0.ee, v.eg, v0.ed,
v0.tg, v0.eg, v0.gg, v0.gd,
v0.td, v0.ed, v0.gd, v0.td),nrow=4, ncol=4, byrow = TRUE)
i0.ep = matrix(c(i0.ee, i0.eg, i0.ed), ncol = 3)
i0.pp = matrix(c(i0.tt, i0.gg, i0.dd, i0.gg, i0.gg, i0.gd,
i0.dd, i0.gd, i0.dd), nrow = 3, ncol = 3)
A0 = i0.ee - i0.ep %*% solve(i0.pp) %*% t(i0.ep)
v0.pe = matrix(c(v0.te, v0.eg, v0.ed), nrow = 3)
v0.pp = matrix(c(v0.tt, v0.tg, v0.td, v0.tg, v0.gg, v0.gd, v0.td,
v0.gd, v0.td), nrow = 3, ncol = 3)
B0 = v0.ee - 2 * i0.ep %*% solve(i0.pp) %*% v0.pe +
i0.ep %*% solve(i0.pp) %*% v0.pp %*% solve(i0.pp) %*% t(i0.ep)
s0 = seq * ( mean(y12) - tao.0[i]*gam.0[i] + mean(y21)- tao.0[i]*del.0[i] )
sna = s0 / A0 * s0 / (2*seq)
srb = s0 / B0 * s0 / (2*seq)
if( sna <= qchisq(0.95, 1) )  S.na1 = S.na1+1
if( srb <= qchisq(0.95, 1) )  S.rb1 = S.rb1+1
}
colMeans(MLE.optim)
log(c(mean(tao),mean(eta),mean(gam),mean(del)))
c(mean(tao),mean(eta),mean(gam),mean(del))
tao[2]
sqrt( sum(y12)*sum(y21)/(sum(y11)*sum(y22)) )
View(df.cor)
y1 <- rbvpois(100000, mean.true[1],  mean.true[2], 2.0)
library(extraDistr)
y1 <- rbvpois(100000, mean.true[1],  mean.true[2], 2.0)
y2 <- rbvpois(100000, mean.true[3],  mean.true[4], 1.5)
cov(y1)
corr(y1)
cor(y1)
cor(y2)
y1 <- rbvpois(100000, mean.true[1],  mean.true[2], 2.0)
y2 <- rbvpois(100000, mean.true[3],  mean.true[4], 2.0)
cor(y2)
cor(y1)
y1 <- rbvpois(100000, mean.true[1],  mean.true[2], 3.0)
y2 <- rbvpois(100000, mean.true[3],  mean.true[4], 3.0)
cor(y1)
cor(y2)
View(y1)
mean.true
y1 <- rbvpois(seq, mean.true[1],  mean.true[2], 3.0)
y2 <- rbvpois(seq, mean.true[3],  mean.true[4], 3.0)
cor(y2)
cor(y1)
y11<-y1[,1];y12<-y1[,2];y21<-y2[,1];y22<-y2[,2]
tao[i]<-mean(y11)
eta[i]<-sqrt( sum(y12)*sum(y21)/(sum(y11)*sum(y22)) )
tao[i]<-mean(y11)
eta[i]<-sqrt( sum(y12)*sum(y21)/(sum(y11)*sum(y22)) )
gam[i]<-sqrt( sum(y12)*sum(y22)/(sum(y11)*sum(y21)) )
del[i]<-sqrt( sum(y21)*sum(y22)/(sum(y11)*sum(y12)) )
mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
cov(y1)
cov(y2)
rm(list=ls(all=TRUE))
require(faraway)
require(numDeriv)
require(MASS)
setwd("C:/Users/User/Documents/Study_CrossoverDesign/RCode")
sim_time=10000;cor_par=1;seq=50
param=c(1.2,0,1.0,0.2)#c(1.2,0,1.0,0.2)#c(0.3,0,0.4,-1.0)
xmat=matrix(c(1,1,1,1, 0,1,1,0, 0,1,0,1, 0,0,1,1), nrow = 4, ncol = 4,byrow = TRUE)
mean.true=exp(param%*%xmat)
X = c(rep(0,seq), rep(1,2*seq), rep(0,seq))
Z = c(rep(0,seq), rep(1,seq), rep(0,seq), rep(1,seq))
G = c(rep(0,2*seq), rep(1,2*seq))
MLE.optim<-matrix(0, nrow = sim_time, ncol = 4)
MLE.glm<-matrix(0, nrow = sim_time, ncol = 4)
MLE.closeform<-matrix(0, nrow = sim_time, ncol = 4)
invI.optim=0;I.glm=0;I.optim=0;invI.glm=0;
I.cf=0;V.cf=0;invI.closeform=0;I0.cf=0;V0.cf=0;invI0.closeform=0
tao<-c();eta<-c();gam<-c();del<-c()
tao.0<-c();eta.0<-c();gam.0<-c();del.0<-c()
W.na1<-0;W.rb1<-0;LR.na1<-0;LR.rb1<-0;S.na1<-0;S.rb1<-0
mean.cor<-matrix(0, nrow = seq, ncol = nchar('ABBA'))
data.cor<-matrix(0, nrow = seq, ncol = nchar('ABBA'))
set.seed(110225021)
for (i in 1:sim_time){
#  nui<-replicate(2,rgamma(n=seq,shape=1/cor_par,scale=cor_par))
#  mean.cor[,1]<-mean.true[,1]*nui[,1]
#  mean.cor[,2]<-mean.true[,2]*nui[,1]
#  mean.cor[,3]<-mean.true[,3]*nui[,2]
#  mean.cor[,4]<-mean.true[,4]*nui[,2]
#
#  for (i in 1:nchar('ABBA')){
#   list_poisson <- unlist(lapply(mean.cor[,i], FUN = function(x) rpois(1, x)))
#   data.cor[,i] <- list_poisson
# }
#  y11<-data.cor[,1];y12<-data.cor[,2];y21<-data.cor[,3];y22<-data.cor[,4]
y1 <- rbvpois(seq, mean.true[1],  mean.true[2], 3.0)
y2 <- rbvpois(seq, mean.true[3],  mean.true[4], 3.0)
y11<-y1[,1];y12<-y1[,2];y21<-y2[,1];y22<-y2[,2]
# l1 <- c(1.33, 2); l2 <- c(0.5, 0.75) # lambda for each new variable
# y1 <- genCorGen(seq, nvars = 2, params1 = l1, dist = "poisson", rho = .4, corstr = "cs", wide = TRUE,cnames='y11,y12')
# y1 <-as.matrix(y1[,c('y11','y12')])
# y2 <- genCorGen(seq, nvars = 2, params1 = l2, dist = "poisson", rho = .4, corstr = "cs", wide = TRUE,cnames='y21,y22')
# y2 <-as.matrix(y2[,c('y21','y22')])
# y11<-y1[,1];y12<-y1[,2];y21<-y2[,1];y22<-y2[,2]
# Y <- c(y11,y12,y21,y22)
#---------------------------------
#closeform MLE:exp(.)
#---------------------------------
tao[i]<-mean(y11)
eta[i]<-sqrt( sum(y12)*sum(y21)/(sum(y11)*sum(y22)) )
gam[i]<-sqrt( sum(y12)*sum(y22)/(sum(y11)*sum(y21)) )
del[i]<-sqrt( sum(y21)*sum(y22)/(sum(y11)*sum(y12)) )
# cov1<-mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
# cov2<-mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
#Matrix I & Matrix V
i.tt<-( tao[i]+tao[i]*eta[i]*gam[i] + tao[i]*eta[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i.gg<-( tao[i]*eta[i]*gam[i] + tao[i]*gam[i]*del[i] )/2
i.ee<-( tao[i]*eta[i]*gam[i] + tao[i]*eta[i]*del[i] )/2
i.dd<- ( tao[i]*eta[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i.eg<- ( tao[i]*eta[i]*gam[i] )/2
i.ed<- ( tao[i]*eta[i]*del[i] )/2
i.gd<- ( tao[i]*gam[i]*del[i] )/2
I<-matrix(c(i.tt,i.ee,i.gg,i.dd,
i.ee,i.ee,i.eg,i.ed,
i.gg,i.eg,i.gg,i.gd,
i.dd,i.ed,i.gd,i.dd),nrow=4, ncol=4, byrow = TRUE)
I.cf<-I.cf+I
cov1<-mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
cov2<-mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
invI.closeform <- invI.closeform + solve(I)
v.tt = i.tt + cov1+cov2#cov(y11,y12)+cov(y21,y22)
v.ee = i.ee
v.gg = i.gg
v.dd = i.dd + cov2#cov(y21,y22)
v.te = i.ee + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.tg = i.gg + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.td = i.dd + cov1#cov(y21,y22)
v.eg = i.eg + cov2/2#cov(y21,y22)/2
v.ed = i.ed + cov2/2#cov(y21,y22)/2
v.gd = i.gd + cov2/2#cov(y21,y22)/2
V.cf<-V.cf+matrix( c(v.tt, v.te, v.tg, v.td,
v.te, v.ee, v.eg, v.ed,
v.tg, v.eg, v.gg, v.gd,
v.td, v.ed, v.gd, v.td),nrow=4, ncol=4, byrow = TRUE)
i.ep = matrix(c(i.ee, i.eg, i.ed), ncol = 3)
i.pp = matrix(c(i.tt, i.gg, i.dd, i.gg, i.gg, i.gd,
i.dd, i.gd, i.dd), nrow = 3, ncol = 3)
A = i.ee - i.ep %*% solve(i.pp) %*% t(i.ep)
v.pe = matrix(c(v.te, v.eg, v.ed), nrow = 3)
v.pp = matrix(c(v.tt, v.tg, v.td, v.tg, v.gg, v.gd, v.td,
v.gd, v.td), nrow = 3, ncol = 3)
B = v.ee - 2 * i.ep %*% solve(i.pp) %*% v.pe +
i.ep %*% solve(i.pp) %*% v.pp %*% solve(i.pp) %*% t(i.ep)
#wald test
wna = log(eta[i]) * A * log(eta[i]) * 2*seq
wrb = log(eta[i]) * A^2 / B * log(eta[i]) * 2*seq
if( wna<=qchisq(0.95, 1) )  W.na1 = W.na1+1
if( wrb<=qchisq(0.95, 1) )  W.rb1 = W.rb1+1
#log LR test :par=exp(.)
lik<-function(par){
ll=sum(log(par[1])*y11-par[1]+log(par[1]*par[2]*par[3])*y12-par[1]*par[2]*par[3])+
sum(log(par[1]*par[2]*par[4])*y21-par[1]*par[2]*par[4]+ log(par[1]*par[3]*par[4])*y22-par[1]*par[3]*par[4])
# ll= par[1]*sum(y11)-seq*exp(param[1])
#   +sum(par[1:3])*sum(y12)-seq*exp(sum(par[1:3]))
#   +(par[1]+par[2]+par[4])*sum(y21)-seq*exp(par[1]+par[2]+param[4])
#   +(par[1]+par[3]+par[4])*sum(y22)-seq*exp(param[1]+param[3]+param[4])
return(ll)
}
#null MLE
Y<-c(y11,y12,y21,y22)
df.cor = data.frame(Y,X,Z,G)
mod.0 <- glm(Y ~ Z + G, family = poisson(link = "log"), df.cor)
tao.0[i]<-exp(mod.0$coefficients[1])
gam.0[i]<-exp(mod.0$coefficients[2])
del.0[i]<-exp(mod.0$coefficients[3])
#null cov
cov1<-mean( (y11-tao.0[i])*(y12-tao.0[i]*gam.0[i]) )
cov2<-mean( (y21-tao.0[i]*del.0[i])*(y22-tao.0[i]*gam.0[i]*del.0[i]) )
#LR Test
l1 = lik(c(tao[i], eta[i], gam[i], del[i]) )
l0 = lik(c(tao.0[i], 1, gam.0[i], del.0[i]))
if( (2*(l1-l0))<=qchisq(0.95, 1) )  LR.na1 = LR.na1+1
if( (2*A/B*(l1-l0))<=qchisq(0.95, 1) )  LR.rb1 = LR.rb1+1
#score test
i0.tt<-( tao.0[i]+tao.0[i]*gam.0[i] + tao.0[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i0.gg<-( tao.0[i]*gam.0[i] + tao.0[i]*gam.0[i]*del.0[i] )/2
i0.ee<-( tao.0[i]*gam.0[i] + tao.0[i]*del.0[i] )/2
i0.dd<- ( tao.0[i]*del.0[i]+tao.0[i]*gam.0[i]*del.0[i] )/2
i0.eg<- ( tao.0[i]*gam.0[i] )/2
i0.ed<- ( tao.0[i]*del.0[i] )/2
i0.gd<- ( tao.0[i]*gam.0[i]*del.0[i] )/2
I0<-matrix(c(i0.tt,i0.ee,i0.gg,i0.dd,
i0.ee,i0.ee,i0.eg,i0.ed,
i0.gg,i0.eg,i0.gg,i0.gd,
i0.dd,i0.ed,i0.gd,i0.dd),nrow=4, ncol=4, byrow = TRUE)
I0.cf<-I0.cf+I0
invI0.closeform <- invI0.closeform + solve(I0)
v0.tt = i0.tt + cov1+cov2
v0.ee = i0.ee
v0.gg = i0.gg
v0.dd.0 = i0.dd + cov2
v0.te = i0.ee + cov1/2+cov2/2
v0.tg = i0.gg + cov1/2+cov2/2
v0.td = i0.dd + cov2
v0.eg = i0.eg + cov2/2
v0.ed = i0.ed + cov2/2
v0.gd = i0.gd + cov2/2
V0.cf<-V.cf+matrix( c(v0.tt, v0.te, v0.tg, v0.td,
v0.te, v0.ee, v.eg, v0.ed,
v0.tg, v0.eg, v0.gg, v0.gd,
v0.td, v0.ed, v0.gd, v0.td),nrow=4, ncol=4, byrow = TRUE)
i0.ep = matrix(c(i0.ee, i0.eg, i0.ed), ncol = 3)
i0.pp = matrix(c(i0.tt, i0.gg, i0.dd, i0.gg, i0.gg, i0.gd,
i0.dd, i0.gd, i0.dd), nrow = 3, ncol = 3)
A0 = i0.ee - i0.ep %*% solve(i0.pp) %*% t(i0.ep)
v0.pe = matrix(c(v0.te, v0.eg, v0.ed), nrow = 3)
v0.pp = matrix(c(v0.tt, v0.tg, v0.td, v0.tg, v0.gg, v0.gd, v0.td,
v0.gd, v0.td), nrow = 3, ncol = 3)
B0 = v0.ee - 2 * i0.ep %*% solve(i0.pp) %*% v0.pe +
i0.ep %*% solve(i0.pp) %*% v0.pp %*% solve(i0.pp) %*% t(i0.ep)
s0 = seq * ( mean(y12) - tao.0[i]*gam.0[i] + mean(y21)- tao.0[i]*del.0[i] )
sna = s0 / A0 * s0 / (2*seq)
srb = s0 / B0 * s0 / (2*seq)
if( sna <= qchisq(0.95, 1) )  S.na1 = S.na1+1
if( srb <= qchisq(0.95, 1) )  S.rb1 = S.rb1+1
}
log(c(mean(tao),mean(eta),mean(gam),mean(del)))
I.cf/sim_time
invI.closeform/sim_time
V.cf/sim_time
(invI.closeform/sim_time)%*%(V.cf/sim_time)%*%(invI.closeform/sim_time)
A
1/A
A/B/B
1-W.na1/sim_time
1-W.rb1/sim_time
1-LR.na1/sim_time
1-LR.rb1/sim_time
1-S.na1/sim_time
1-S.rb1/sim_time
sim_time=20000;cor_par=1;seq=30
rm(list=ls(all=TRUE))
require(faraway)
require(numDeriv)
require(MASS)
setwd("C:/Users/User/Documents/Study_CrossoverDesign/RCode")
sim_time=20000;cor_par=1;seq=30
param=c(1.2,0,1.0,0.2)#c(1.2,0,1.0,0.2)#c(0.3,0,0.4,-1.0)
xmat=matrix(c(1,1,1,1, 0,1,1,0, 0,1,0,1, 0,0,1,1), nrow = 4, ncol = 4,byrow = TRUE)
mean.true=exp(param%*%xmat)
X = c(rep(0,seq), rep(1,2*seq), rep(0,seq))
Z = c(rep(0,seq), rep(1,seq), rep(0,seq), rep(1,seq))
G = c(rep(0,2*seq), rep(1,2*seq))
MLE.optim<-matrix(0, nrow = sim_time, ncol = 4)
MLE.glm<-matrix(0, nrow = sim_time, ncol = 4)
MLE.closeform<-matrix(0, nrow = sim_time, ncol = 4)
invI.optim=0;I.glm=0;I.optim=0;invI.glm=0;
I.cf=0;V.cf=0;invI.closeform=0;I0.cf=0;V0.cf=0;invI0.closeform=0
tao<-c();eta<-c();gam<-c();del<-c()
tao.0<-c();eta.0<-c();gam.0<-c();del.0<-c()
W.na1<-0;W.rb1<-0;LR.na1<-0;LR.rb1<-0;S.na1<-0;S.rb1<-0
mean.cor<-matrix(0, nrow = seq, ncol = nchar('ABBA'))
data.cor<-matrix(0, nrow = seq, ncol = nchar('ABBA'))
set.seed(110225021)
for (i in 1:sim_time){
#  nui<-replicate(2,rgamma(n=seq,shape=1/cor_par,scale=cor_par))
#  mean.cor[,1]<-mean.true[,1]*nui[,1]
#  mean.cor[,2]<-mean.true[,2]*nui[,1]
#  mean.cor[,3]<-mean.true[,3]*nui[,2]
#  mean.cor[,4]<-mean.true[,4]*nui[,2]
#
#  for (i in 1:nchar('ABBA')){
#   list_poisson <- unlist(lapply(mean.cor[,i], FUN = function(x) rpois(1, x)))
#   data.cor[,i] <- list_poisson
# }
#  y11<-data.cor[,1];y12<-data.cor[,2];y21<-data.cor[,3];y22<-data.cor[,4]
y1 <- rbvpois(seq, mean.true[1],  mean.true[2], 3.0)
y2 <- rbvpois(seq, mean.true[3],  mean.true[4], 3.0)
y11<-y1[,1];y12<-y1[,2];y21<-y2[,1];y22<-y2[,2]
# l1 <- c(1.33, 2); l2 <- c(0.5, 0.75) # lambda for each new variable
# y1 <- genCorGen(seq, nvars = 2, params1 = l1, dist = "poisson", rho = .4, corstr = "cs", wide = TRUE,cnames='y11,y12')
# y1 <-as.matrix(y1[,c('y11','y12')])
# y2 <- genCorGen(seq, nvars = 2, params1 = l2, dist = "poisson", rho = .4, corstr = "cs", wide = TRUE,cnames='y21,y22')
# y2 <-as.matrix(y2[,c('y21','y22')])
# y11<-y1[,1];y12<-y1[,2];y21<-y2[,1];y22<-y2[,2]
# Y <- c(y11,y12,y21,y22)
#---------------------------------
#closeform MLE:exp(.)
#---------------------------------
tao[i]<-mean(y11)
eta[i]<-sqrt( sum(y12)*sum(y21)/(sum(y11)*sum(y22)) )
gam[i]<-sqrt( sum(y12)*sum(y22)/(sum(y11)*sum(y21)) )
del[i]<-sqrt( sum(y21)*sum(y22)/(sum(y11)*sum(y12)) )
# cov1<-mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
# cov2<-mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
#Matrix I & Matrix V
i.tt<-( tao[i]+tao[i]*eta[i]*gam[i] + tao[i]*eta[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i.gg<-( tao[i]*eta[i]*gam[i] + tao[i]*gam[i]*del[i] )/2
i.ee<-( tao[i]*eta[i]*gam[i] + tao[i]*eta[i]*del[i] )/2
i.dd<- ( tao[i]*eta[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i.eg<- ( tao[i]*eta[i]*gam[i] )/2
i.ed<- ( tao[i]*eta[i]*del[i] )/2
i.gd<- ( tao[i]*gam[i]*del[i] )/2
I<-matrix(c(i.tt,i.ee,i.gg,i.dd,
i.ee,i.ee,i.eg,i.ed,
i.gg,i.eg,i.gg,i.gd,
i.dd,i.ed,i.gd,i.dd),nrow=4, ncol=4, byrow = TRUE)
I.cf<-I.cf+I
cov1<-mean( (y11-tao[i])*(y12-tao[i]*eta[i]*gam[i]) )
cov2<-mean( (y21-tao[i]*eta[i]*del[i])*(y22-tao[i]*gam[i]*del[i]) )
invI.closeform <- invI.closeform + solve(I)
v.tt = i.tt + cov1+cov2#cov(y11,y12)+cov(y21,y22)
v.ee = i.ee
v.gg = i.gg
v.dd = i.dd + cov2#cov(y21,y22)
v.te = i.ee + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.tg = i.gg + cov1/2+cov2/2#cov(y11,y12)/2+cov(y21,y22)/2
v.td = i.dd + cov1#cov(y21,y22)
v.eg = i.eg + cov2/2#cov(y21,y22)/2
v.ed = i.ed + cov2/2#cov(y21,y22)/2
v.gd = i.gd + cov2/2#cov(y21,y22)/2
V.cf<-V.cf+matrix( c(v.tt, v.te, v.tg, v.td,
v.te, v.ee, v.eg, v.ed,
v.tg, v.eg, v.gg, v.gd,
v.td, v.ed, v.gd, v.td),nrow=4, ncol=4, byrow = TRUE)
i.ep = matrix(c(i.ee, i.eg, i.ed), ncol = 3)
i.pp = matrix(c(i.tt, i.gg, i.dd, i.gg, i.gg, i.gd,
i.dd, i.gd, i.dd), nrow = 3, ncol = 3)
A = i.ee - i.ep %*% solve(i.pp) %*% t(i.ep)
v.pe = matrix(c(v.te, v.eg, v.ed), nrow = 3)
v.pp = matrix(c(v.tt, v.tg, v.td, v.tg, v.gg, v.gd, v.td,
v.gd, v.td), nrow = 3, ncol = 3)
B = v.ee - 2 * i.ep %*% solve(i.pp) %*% v.pe +
i.ep %*% solve(i.pp) %*% v.pp %*% solve(i.pp) %*% t(i.ep)
#wald test
wna = log(eta[i]) * A * log(eta[i]) * 2*seq
wrb = log(eta[i]) * A^2 / B * log(eta[i]) * 2*seq
if( wna<=qchisq(0.95, 1) )  W.na1 = W.na1+1
if( wrb<=qchisq(0.95, 1) )  W.rb1 = W.rb1+1
#log LR test :par=exp(.)
lik<-function(par){
ll=sum(log(par[1])*y11-par[1]+log(par[1]*par[2]*par[3])*y12-par[1]*par[2]*par[3])+
sum(log(par[1]*par[2]*par[4])*y21-par[1]*par[2]*par[4]+ log(par[1]*par[3]*par[4])*y22-par[1]*par[3]*par[4])
# ll= par[1]*sum(y11)-seq*exp(param[1])
#   +sum(par[1:3])*sum(y12)-seq*exp(sum(par[1:3]))
#   +(par[1]+par[2]+par[4])*sum(y21)-seq*exp(par[1]+par[2]+param[4])
#   +(par[1]+par[3]+par[4])*sum(y22)-seq*exp(param[1]+param[3]+param[4])
return(ll)
}
#null MLE
Y<-c(y11,y12,y21,y22)
df.cor = data.frame(Y,X,Z,G)
mod.0 <- glm(Y ~ Z + G, family = poisson(link = "log"), df.cor)
tao.0[i]<-exp(mod.0$coefficients[1])
gam.0[i]<-exp(mod.0$coefficients[2])
del.0[i]<-exp(mod.0$coefficients[3])
#null cov
cov1<-mean( (y11-tao.0[i])*(y12-tao.0[i]*gam.0[i]) )
cov2<-mean( (y21-tao.0[i]*del.0[i])*(y22-tao.0[i]*gam.0[i]*del.0[i]) )
#LR Test
l1 = lik(c(tao[i], eta[i], gam[i], del[i]) )
l0 = lik(c(tao.0[i], 1, gam.0[i], del.0[i]))
if( (2*(l1-l0))<=qchisq(0.95, 1) )  LR.na1 = LR.na1+1
if( (2*A/B*(l1-l0))<=qchisq(0.95, 1) )  LR.rb1 = LR.rb1+1
#score test
i0.tt<-( tao.0[i]+tao.0[i]*gam.0[i] + tao.0[i]*del[i]+tao[i]*gam[i]*del[i] )/2
i0.gg<-( tao.0[i]*gam.0[i] + tao.0[i]*gam.0[i]*del.0[i] )/2
i0.ee<-( tao.0[i]*gam.0[i] + tao.0[i]*del.0[i] )/2
i0.dd<- ( tao.0[i]*del.0[i]+tao.0[i]*gam.0[i]*del.0[i] )/2
i0.eg<- ( tao.0[i]*gam.0[i] )/2
i0.ed<- ( tao.0[i]*del.0[i] )/2
i0.gd<- ( tao.0[i]*gam.0[i]*del.0[i] )/2
I0<-matrix(c(i0.tt,i0.ee,i0.gg,i0.dd,
i0.ee,i0.ee,i0.eg,i0.ed,
i0.gg,i0.eg,i0.gg,i0.gd,
i0.dd,i0.ed,i0.gd,i0.dd),nrow=4, ncol=4, byrow = TRUE)
I0.cf<-I0.cf+I0
invI0.closeform <- invI0.closeform + solve(I0)
v0.tt = i0.tt + cov1+cov2
v0.ee = i0.ee
v0.gg = i0.gg
v0.dd.0 = i0.dd + cov2
v0.te = i0.ee + cov1/2+cov2/2
v0.tg = i0.gg + cov1/2+cov2/2
v0.td = i0.dd + cov2
v0.eg = i0.eg + cov2/2
v0.ed = i0.ed + cov2/2
v0.gd = i0.gd + cov2/2
V0.cf<-V.cf+matrix( c(v0.tt, v0.te, v0.tg, v0.td,
v0.te, v0.ee, v.eg, v0.ed,
v0.tg, v0.eg, v0.gg, v0.gd,
v0.td, v0.ed, v0.gd, v0.td),nrow=4, ncol=4, byrow = TRUE)
i0.ep = matrix(c(i0.ee, i0.eg, i0.ed), ncol = 3)
i0.pp = matrix(c(i0.tt, i0.gg, i0.dd, i0.gg, i0.gg, i0.gd,
i0.dd, i0.gd, i0.dd), nrow = 3, ncol = 3)
A0 = i0.ee - i0.ep %*% solve(i0.pp) %*% t(i0.ep)
v0.pe = matrix(c(v0.te, v0.eg, v0.ed), nrow = 3)
v0.pp = matrix(c(v0.tt, v0.tg, v0.td, v0.tg, v0.gg, v0.gd, v0.td,
v0.gd, v0.td), nrow = 3, ncol = 3)
B0 = v0.ee - 2 * i0.ep %*% solve(i0.pp) %*% v0.pe +
i0.ep %*% solve(i0.pp) %*% v0.pp %*% solve(i0.pp) %*% t(i0.ep)
s0 = seq * ( mean(y12) - tao.0[i]*gam.0[i] + mean(y21)- tao.0[i]*del.0[i] )
sna = s0 / A0 * s0 / (2*seq)
srb = s0 / B0 * s0 / (2*seq)
if( sna <= qchisq(0.95, 1) )  S.na1 = S.na1+1
if( srb <= qchisq(0.95, 1) )  S.rb1 = S.rb1+1
}
1-W.na1/sim_time
1-W.rb1/sim_time
1-LR.na1/sim_time
1-LR.rb1/sim_time
1-S.na1/sim_time
1-S.rb1/sim_time
log(c(mean(tao),mean(eta),mean(gam),mean(del)))
I.cf/sim_time
invI.closeform/sim_time
V.cf/sim_time
(invI.closeform/sim_time)%*%(V.cf/sim_time)%*%(invI.closeform/sim_time)
cov.m<-2*seq*matrix(c(var(log(tao)),cov(log(tao),log(eta)),cov(log(tao),log(gam)),cov(log(tao),log(del)),
cov(log(tao),log(eta)),var(log(eta)),cov(log(gam),log(eta)),cov(log(del),log(eta)),
cov(log(tao),log(gam)),cov(log(gam),log(eta)),var(log(gam)),cov(log(gam),log(del)),
cov(log(tao),log(del)),cov(log(del),log(eta)),cov(log(gam),log(del)),var(log(del))), nrow = 4, ncol = 4,byrow = TRUE)
cov.m
(invI.closeform/sim_time)%*%(V.cf/sim_time)%*%(invI.closeform/sim_time)
